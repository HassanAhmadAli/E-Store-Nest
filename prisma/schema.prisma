generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
  engineType   = "client"
}

//turn off
// generator zod {
//   provider = "prisma-zod-generator"
//   output   = "../generated/prisma/zod"
//   config   = "./zod-generator.config.json"
// }

datasource db {
  provider = "postgresql"
}

enum ComplaintStatus {
  Pending
  InProgress
  Resolved
  Rejected
}

enum Role {
  Admin
  Citizen
  Employee
  Debugging
}

enum Priority {
  Low
  Medium
  High
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
}

model Complaint {
  id          Int             @id @default(autoincrement())
  title       String
  description String
  status      ComplaintStatus @default(Pending)
  isArchived  Boolean         @default(false)

  citizenId          Int
  assignedEmployeeId Int?

  citizen          User           @relation("CitizenComplaints", fields: [citizenId], references: [id], onDelete: Restrict)
  assignedEmployee User?          @relation("EmployeeComplaints", fields: [assignedEmployeeId], references: [id], onDelete: SetNull)
  logs             ComplaintLog[]
  notifications    Notification[]
  attachments      Attachment[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([citizenId])
  @@index([assignedEmployeeId])
  @@index([status])
}

model ComplaintLog {
  id          Int         @id @default(autoincrement())
  complaintId Int
  changedById Int
  action      AuditAction
  changes     Json
  notes       String?

  complaint Complaint @relation(fields: [complaintId], references: [id])
  changedBy User      @relation(fields: [changedById], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([complaintId])
}

model Attachment {
  id          Int       @id @default(autoincrement())
  fileUrl     String
  fileType    String
  fileSize    Int?
  complaintId Int
  complaint   Complaint @relation(fields: [complaintId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([complaintId])
}

model User {
  id          Int     @id @default(autoincrement())
  fullName    String
  email       String  @unique
  phoneNumber String
  password    String
  nationalId  String  @unique
  role        Role
  isActive    Boolean @default(true)

  isVerified                Boolean   @default(false)
  verificationCode          String?
  verificationCodeExpiresAt DateTime?

  complaintsFiled    Complaint[]    @relation("CitizenComplaints")
  complaintsAssigned Complaint[]    @relation("EmployeeComplaints")
  logsCreated        ComplaintLog[] // Tracks who updated a complaint status
  notifications      Notification[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Notification {
  id      Int     @id @default(autoincrement())
  message String
  isRead  Boolean @default(false)

  userId      Int
  complaintId Int?

  user      User       @relation(fields: [userId], references: [id])
  complaint Complaint? @relation(fields: [complaintId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
}
