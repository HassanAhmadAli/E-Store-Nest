generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
  engineType   = "client"
}

// // // // turn off

// generator zod {
//   provider = "prisma-zod-generator"
//   output   = "../generated/prisma/zod"
//   config   = "./zod-generator.config.json"
// }

datasource db {
  provider = "postgresql"
}

enum ComplaintStatus {
  Pending
  InProgress
  Resolved
  Rejected
}

enum Role {
  Admin
  Citizen
  Employee
  Debugging
}

enum ComplaintPriority {
  Low
  Medium
  High
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
}

model Department {
  id          Int     @id @default(autoincrement())
  // core fields
  name        String  @unique
  description String?

  // relations
  employees  User[]
  complaints Complaint[]

  //
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Complaint {
  id                String            @id @default(cuid())
  // core fields
  referenceCode     String            @unique @default(uuid()) // Unique public reference
  title             String
  description       String
  status            ComplaintStatus   @default(Pending)
  complaintPriority ComplaintPriority @default(Medium)
  isArchived        Boolean           @default(false)
  location          String? // Or use Float for lat/lng if using maps
  lockedAt          DateTime?

  // forign keys
  departmentId       Int
  citizenId          Int
  assignedEmployeeId Int?
  lockedById         Int?
  // relations
  department         Department     @relation(fields: [departmentId], references: [id])
  citizen            User           @relation("CitizenComplaints", fields: [citizenId], references: [id], onDelete: Restrict)
  assignedEmployee   User?          @relation("EmployeeComplaints", fields: [assignedEmployeeId], references: [id], onDelete: SetNull)
  lockedBy           User?          @relation("UserLockedComplaints", fields: [lockedById], references: [id])
  logs               ComplaintLog[]
  notifications      Notification[]
  attachments        Attachment[]
  comments           Comment[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([citizenId])
  @@index([assignedEmployeeId])
  @@index([departmentId])
  @@index([status])
  @@index([referenceCode])
}

model Comment {
  id          Int    @id @default(autoincrement())
  // core fields
  content     String
  // forigne keys
  complaintId String
  userId      Int

  // relations
  complaint Complaint @relation(fields: [complaintId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  //
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  //
  @@index([complaintId])
  @@index([userId])
}

model ComplaintLog {
  id      Int         @id @default(autoincrement())
  // core fields
  action  AuditAction
  changes Json
  notes   String?

  // forign keys 
  complaintId String
  changedById Int
  // relations
  complaint   Complaint @relation(fields: [complaintId], references: [id])
  changedBy   User      @relation(fields: [changedById], references: [id])

  //
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  //
  @@index([complaintId])
}

model Attachment {
  id           Int    @id @default(autoincrement())
  storedFileId String
  // forign keys
  creatorId    Int
  complaintId  String

  // relations
  complaint  Complaint  @relation(fields: [complaintId], references: [id])
  storedFile StoredFile @relation(fields: [storedFileId], references: [id])
  creator    User       @relation(fields: [creatorId], references: [id])
  //
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deletedAt  DateTime?

  @@index([complaintId])
}

model StoredFile {
  id           String @unique
  originalname String
  mimetype     String
  path         String @unique
  size         Int

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  attachments Attachment[]
}

model User {
  id          Int     @id @default(autoincrement())
  // core fields
  fullName    String
  email       String  @unique
  phoneNumber String  @unique
  password    String
  nationalId  String  @unique
  role        Role
  isActive    Boolean @default(true)

  isVerified                Boolean   @default(false)
  verificationCode          String?
  verificationCodeExpiresAt DateTime?

  // forign keys
  departmentId Int?

  // relations
  department         Department?    @relation(fields: [departmentId], references: [id])
  complaintsFiled    Complaint[]    @relation("CitizenComplaints")
  complaintsAssigned Complaint[]    @relation("EmployeeComplaints")
  complaints         Complaint[]    @relation("UserLockedComplaints")
  logsCreated        ComplaintLog[] // Tracks who updated a complaint status
  notifications      Notification[]
  comments           Comment[]

  //
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  attachments Attachment[]

  //
  @@index([departmentId])
  @@index([email, role, id])
}

model Notification {
  id      Int     @id @default(autoincrement())
  // core fields
  message String
  isRead  Boolean @default(false)

  // forign keys
  userId      Int
  complaintId String?

  // relations
  user      User       @relation(fields: [userId], references: [id])
  complaint Complaint? @relation(fields: [complaintId], references: [id])

  //
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  //
  @@index([userId, complaintId])
}
